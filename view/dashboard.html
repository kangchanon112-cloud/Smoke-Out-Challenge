<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard Compact</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #fbdfc7;
      font-family: "Prompt", sans-serif;
      padding: 20px;
      color: #333;
    }

    h1 {
      color: #6b4f3f;
      margin-bottom: 20px;
    }

    .top-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .table-container {
      overflow-x: auto;
      background-color: #fff6ec;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: #ffe9c4;
      color: #6b4f3f;
      font-weight: 600;
      padding: 8px;
    }

    td {
      padding: 8px;
    }

    tbody tr:nth-of-type(odd) {
      background-color: #fff3e6;
    }

    .btn-export {
      background-color: #ffe9c4;
      color: #6b4f3f;
      font-weight: 600;
    }

    .btn-export:hover {
      background-color: #e2d7c5;
      color: #fff;
    }

    .search-input {
      max-width: 200px;
    }

    #alertModal .modal-content {
      background-color: #fff3e6;
      color: #6b4f3f;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #editModal .modal-content {
      background-color: #fff6ec;
      color: #6b4f3f;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #editModal .btn-primary {
      background-color: #6b4f3f;
      border-color: #6b4f3f;
    }

    #editModal .btn-primary:hover {
      background-color: #5a4233;
      border-color: #5a4233;
    }
  </style>

</head>

<body>
  <h1 class="d-flex justify-content-between align-items-center">
    <span>Admin Dashboard</span>
    <a href="/admin" class="btn btn-sm" style="background-color:#6b4f3f; color:white; border-radius:6px;">
      หน้า PART
    </a>
  </h1>

  <div class="top-controls">
    <select id="tableSelect" class="form-select" style="max-width:180px;">
      <option value="users">Users</option>
      <option value="quizscores">Quiz Scores</option>
      <option value="answers">Answers</option>
      <option value="profiles">Profiles</option>
      <option value="messages">Messages</option>
      <option value="feedback">Feedback</option>
      <option value="partstatus">Part Status</option>
    </select>

    <div class="top-bar d-flex align-items-center gap-2">
      <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search..."
        style="max-width:180px;">
      <a id="exportBtn" href="/export/users-xlsx" title="Export Excel"
        class="btn btn-sm btn-export d-flex align-items-center">
        <i class="bi bi-file-earmark-excel-fill" style="font-size:1.2rem; margin-right:4px;"></i>Export
      </a>
    </div>
  </div>

  <div class="table-container">
    <table class="table table-striped" id="dataTable">
      <thead>
        <tr id="tableHead"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body" id="alertModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ตกลง</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">แก้ไขข้อมูล</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm"></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">บันทึก</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const tableSelect = document.getElementById('tableSelect');
    const searchInput = document.getElementById('searchInput');
    const exportBtn = document.getElementById('exportBtn');
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.querySelector('#dataTable tbody');
    const tables = {
      users: {
        endpoint: '/admin/users',
        fields: ['_id', 'username', 'password', 'role'],
        headers: ['ID', 'Username', 'Password', 'Role'],
        export: '/export/users-xlsx'
      },
      quizscores: {
        endpoint: '/admin/quizscores',
        fields: ['username', 'quizNumber', 'score'],  
        headers: ['Username', 'Quiz', 'Score'],
        export: '/export/quizscores-xlsx'
      },
      answers: {
        endpoint: '/admin/answers',
        fields: ['username', 'questionId', 'answer', 'date'],
        headers: ['Username', 'Question ID', 'Answer', 'Date'],
        export: '/export/answers-xlsx'
      },
      profiles: {
        endpoint: '/admin/profiles',
        fields: ['username', 'name', 'age', 'gender', 'date'],
        headers: ['Username', 'Name', 'Age', 'Gender', 'Date'],
        export: '/export/profiles-xlsx'
      },
      messages: {
        endpoint: '/admin/messages',
        fields: ['username', 'question', 'message', 'timestamp'],
        headers: ['Username', 'Question', 'Message', 'Timestamp'],
        export: '/export/messages-xlsx'
      },
      feedback: {
        endpoint: '/admin/feedback',
        fields: ['username', 'rating', 'feedback', 'date'],
        headers: ['Username', 'Rating', 'Feedback', 'Date'],
        export: '/export/feedback-xlsx'
      },
      partstatus: {
        endpoint: '/admin/partstatus',
        fields: ['part1', 'part2', 'part3', 'part4'],
        headers: ['Part1', 'Part2', 'Part3', 'Part4'],
        export: '/export/partstatus-xlsx'
      }
    };

    let currentTable = 'users';
    let currentEditId = null;
    let currentEditTable = null;

    // ================= LOAD DATA =================
    async function loadData(tableKey) {
      const t = tables[tableKey];
      exportBtn.href = t.export;

      tableHead.innerHTML = t.headers.map(h => `<th>${h}</th>`).join('') + '<th>Actions</th>';

      try {
        const res = await fetch(t.endpoint);
        const data = await res.json();
        const key = Object.keys(data).find(k => k !== 'success');
        tableBody.innerHTML = '';

        (data[key] || []).forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = t.fields.map(f => `<td>${item[f] ?? ''}</td>`).join('');

          const actionTd = document.createElement('td');
          actionTd.innerHTML = `
        <button class="btn btn-sm btn-warning me-1" onclick="editRow('${tableKey}', '${item._id}')">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteRow('${tableKey}', '${item._id}')">
          <i class="bi bi-trash"></i>
        </button>
      `;
          tr.appendChild(actionTd);
          tableBody.appendChild(tr);
        });
      } catch (err) { console.error(err); }
    }

    // ================= EDIT ROW =================
    async function editRow(tableKey, id) {
      const t = tables[tableKey];
      const rowData = [...tableBody.querySelectorAll('tr')].find(r => r.cells[0].innerText === id);
      if (!rowData) return alert("ไม่พบข้อมูล!");

      const form = document.getElementById('editForm');
      form.innerHTML = '';
      currentEditId = id;
      currentEditTable = tableKey;

      for (let i = 1; i < t.fields.length; i++) {
        const field = t.fields[i];
        const value = rowData.cells[i].innerText;

        const div = document.createElement('div');
        div.classList.add('mb-3');
        div.innerHTML = `
      <label class="form-label">${field}</label>
      <input type="text" class="form-control" name="${field}" value="${value}">
    `;
        form.appendChild(div);
      }

      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // ================= SAVE EDIT =================
    document.getElementById('saveEditBtn').addEventListener('click', async () => {
      const form = document.getElementById('editForm');
      const inputs = form.querySelectorAll('input');
      const updated = {};
      inputs.forEach(input => { updated[input.name] = input.value; });

      const t = tables[currentEditTable];
      try {
        const res = await fetch(`${t.endpoint}/${currentEditId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated)
        });
        const result = await res.json();
        if (result.success) {
          showAlert("อัพเดตสำเร็จ");
          loadData(currentEditTable);
          bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        } else {
          showAlert("อัพเดตล้มเหลว");
        }
      } catch (err) { console.error(err); showAlert("เกิดข้อผิดพลาด"); }
    });

    // ================= DELETE ROW =================
    async function deleteRow(tableKey, id) {
      if (!confirm("คุณต้องการลบข้อมูลนี้หรือไม่?")) return;

      const t = tables[tableKey];
      try {
        const res = await fetch(`${t.endpoint}/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
          showAlert("ลบข้อมูลสำเร็จ");
          loadData(currentTable);
        } else {
          showAlert("ลบข้อมูลล้มเหลว");
        }
      } catch (err) { console.error(err); showAlert("เกิดข้อผิดพลาด"); }
    }

    // ================= SEARCH =================
    searchInput.addEventListener('input', () => {
      const filter = searchInput.value.toLowerCase();
      tableBody.querySelectorAll('tr').forEach(row => {
        let show = Array.from(row.cells).some(cell => cell.textContent.toLowerCase().includes(filter));
        row.style.display = show ? '' : 'none';
      });
    });

    // ================= CHANGE TABLE =================
    tableSelect.addEventListener('change', () => {
      currentTable = tableSelect.value;
      loadData(currentTable);
      searchInput.value = '';
    });

    // ================= INITIAL LOAD =================
    loadData(currentTable);
    setInterval(() => loadData(currentTable), 10000);

    function showAlert(message) {
      const modalBody = document.getElementById('alertModalBody');
      modalBody.innerText = message;
      const modal = new bootstrap.Modal(document.getElementById('alertModal'));
      modal.show();
    }

  </script>

</body>

</html>